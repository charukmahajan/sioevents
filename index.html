<!--
    Author: Charuk Mahajan.
    MIT License

    Copyright (c) 2023 Charuk Mahajan

    Permission is hereby granted, free of charge, to any person obtaining a copy
    of this software and associated documentation files (the "Software"), to deal
    in the Software without restriction, including without limitation the rights
    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
    copies of the Software, and to permit persons to whom the Software is
    furnished to do so, subject to the following conditions:

    The above copyright notice and this permission notice shall be included in all
    copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
    SOFTWARE.
-->
<!DOCTYPE html>
<html lang="en" ng-app="main">

<head>
    <title>SIO</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/aes.js" integrity="sha256-/H4YS+7aYb9kJ5OKhFYPUjSJdrtV6AeyJOtTkw6X72o=" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
        }
        
        th {
            background-color: blue;
            color: white;
            font-weight: bold;
        }
        
        th,
        td {
            text-align: left;
            padding: 8px;
            vertical-align: top;
        }
        
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        /* Remove the navbar's default margin-bottom and rounded borders */
        
        .navbar {
            margin-bottom: 0;
            border-radius: 0;
        }
        
        p {
            margin-bottom: .65rem;
            /*padding: 0px 30px;*/
        }
        
        .btn {
            padding: .375rem .5rem;
        }
        
        .sidenav {
            padding-left: 5px;
            padding-right: 5px;
            padding-top: 10px !important;
        }
        /* Set height of the grid so .sidenav can be 100% (adjust as needed) */
        
        .row.content {
            height: 100vh
        }
        /* Set gray background color and 100% height */
        
        .sidenav {
            padding-top: 20px;
            background-color: #f1f1f1;
            height: 100%;
        }
        /* Set black background color, white text and some padding */
        
        .card-body {
            padding: 5px!important;
        }
        
        footer {
            background-color: #555;
            color: white;
            padding: 15px;
        }
        
        .passwordtext>input {
            color: transparent;
            background-color: transparent;
            border: none;
        }
        
        .passwordtext>input:hover {
            color: inherit;
        }
        
        .error {
            color: red;
            font-size: small;
        }
        
        .font12 {
            font-size: 12px;
        }
        
        .font13 {
            font-size: 13px;
        }
        
        .font14 {
            font-size: 14px;
        }
        
        .font30 {
            font-size: 30px;
        }
        /* On small screens, set height to 'auto' for sidenav and grid */
        
        @media screen and (max-width: 767px) {
            .sidenav {
                height: auto;
                padding: 15px;
            }
            .row.content {
                height: auto;
            }
        }
    </style>
</head>

<body ng-controller="MainColtroller as vm">
    <div class="container-fluid text-center">
        <div class="row content">
            <div class="col-sm-2 sidenav">
                <div class="card">
                    <div class="card-body">
                        <div class="card-title pull-right" style="cursor: pointer;" ng-click="vm.addNewOrder()"><i class="fa fa-2x fa-plus-square" aria-hidden="true"></i></div>
                        <br/>
                        <input type="text" style="width: 90%;height: 24px;" placeholder="Type to filter" ng-model="vm.filter" />
                        <p ng-repeat="data in vm.data |filter:vm.filter" style="text-align: left;" class="font14">
                            <a ng-click="vm.addItem(data, vm.currentIndex)" href="javascript:void(0);" title="{{data.description}}">{{$index+1}}. {{data.name}}</a>
                            <!--<button ng-if="data.class" type="button" ng-class="data.class" class="btn btn-block btn-sm" ng-click="vm.performAction(data.action)">{{data.name}}<span ng-if="data.openCount" style="float: right;font-size: 8px;"><b>{{data.openCount}}</b></span></button>
                            <button ng-if="!data.class" type="button" ng-class="{'btn-success': $index % 2 == 0, 'btn-outline-success': $index % 2 != 0 }" class="btn btn-block btn-sm" ng-click="vm.performAction(data.action)">{{data.name}}<span ng-if="data.openCount" style="float: right;font-size: 8px;"><b>{{data.openCount}}</b></span></button>-->
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-sm-2 sidenav" style="height: 60%;" ng-repeat="order in vm.orders" id="kot{{$index}}" ng-hide="order.isCompleted">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title"><b><span ng-if="!order.custName">KOT</span><span style="font-size: 13px;float: left;">{{$index+1}}<span ng-if="order.custName">.</span></span> {{order.custName}}</b></h5>
                        <div ng-repeat="item in order.order" style="text-align: left; margin-bottom: 15px;" class="font12">
                            {{item.name}} <span style="float: right;"><a ng-click="vm.removeItem(item, $parent.$index)" href="javascript:void(0);"><i class="fa fa-minus" aria-hidden="true"></i></a> <span style="font-size: 10px;">{{item.quantity}}</span>
                            <a ng-click="vm.addItem(item, $parent.$index)" href="javascript:void(0);"><i class="fa fa-plus" aria-hidden="true"></i></a> {{item.totalPrice}}
                            </span>
                        </div>
                        <span style="border-top: dotted 1px;margin-top: 3px;float: right;">{{vm.getTotal($index)}}</span>
                        <br/>
                        <hr/>
                        <button type="button" class="btn btn-danger btn-sm" ng-click="vm.discardKOT($index)">Discard</button>
                        <button ng-disabled="order.order.length==0" type="button" class="btn btn-success btn-sm" ng-click="vm.completeKOT($index)">Complete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <a id="downloadAnchorElem" style="display:none"></a>
    <script type="text/javascript">
        var mainModule = angular.module('main', []);
        mainModule.controller('MainColtroller', MainColtroller);

        function MainColtroller($scope, $timeout) {
            var vm = this,
                backUpKey = 'sioOrdersData';
            vm.currentOrder = [];
            vm.orders = [];
            vm.currentIndex = -1;

            vm.addItem = addItem;
            vm.removeItem = removeItem;
            vm.addNewOrder = addNewOrder;
            vm.getTotal = getTotal;
            vm.discardKOT = discardKOT;
            vm.completeKOT = completeKOT;
            vm.printKOT = printKOT;

            init();

            function init() {
                var data = getDataFromLocalStorage(backUpKey);
                if (data) {
                    vm.orders = data;
                    vm.currentIndex = vm.orders.length - 1;
                }
                if (reloadNeeded()) {
                    sessionStorage.setItem('sioPageReloaded', 'true');
                    location.href = location.href + '?v=' + (new Date()).getTime();
                }
            }

            function reloadNeeded() {
                var reloaded = sessionStorage.getItem('sioPageReloaded');
                if (reloaded) {
                    return false;
                }
                return true;
            }

            function printKOT(index) {
                var prtContent = document.getElementById('kot' + index);
                var WinPrint = window.open('', '', 'left=0,top=0,width=800,height=900,toolbar=0,scrollbars=0,status=0');
                if (!WinPrint) {
                    alert('Please allow popups.');
                    return;
                }
                $(prtContent).find('button').css('display', 'none');
                WinPrint.document.write(prtContent.innerHTML);
                WinPrint.document.close();
                WinPrint.focus();
                WinPrint.print();
                WinPrint.close();
                $(prtContent).find('button').css('display', '');
                vm.orders[index].isCompleted = true;
            }

            function completeKOT(index) {
                var conf = confirm('Are you sure you want to complete this KOT. This action can\'t be reverted.');
                if (conf) {
                    vm.printKOT(index);
                    saveDataInLocalStorage(vm.orders, backUpKey);
                }
            }

            function discardKOT(index) {
                var conf = confirm('Are you sure you want to discard this KOT. This action can\'t be reverted.');
                if (conf) {
                    vm.orders.splice(index, 1);
                    vm.currentIndex--;
                    saveDataInLocalStorage(vm.orders, backUpKey);
                }
            }

            function getTotal(index) {
                return _.chain(vm.orders[index].order).map('totalPrice').sum().value();
            }

            function addNewOrder() {
                //vm.orders = Object.assign([], vm.orders);
                var custName = prompt('Please enter customer name');
                vm.orders.push({
                    'custName': custName,
                    order: []
                });
                console.log(vm.orders)
                vm.currentIndex++;
                saveDataInLocalStorage(vm.orders, backUpKey);
            }

            function removeItem(data, index) {
                if (index < 0) {
                    return;
                }
                if (!index) {
                    index = 0;
                }
                if (!vm.orders[index]) {
                    vm.orders[index] = [];
                }
                var indx = _.findIndex(vm.orders[index].order, function(o, i) {
                    return o.name == data.name;
                });
                if (vm.orders[index].order[indx].quantity > 1) {
                    vm.orders[index].order[indx].quantity--;
                    vm.orders[index].order[indx].totalPrice = vm.orders[index].order[indx].quantity * vm.orders[index].order[indx].price;
                } else {
                    vm.orders[index].order.splice(indx, 1);
                    if (vm.orders.length === 0) {
                        vm.orders.push([]);
                    }
                }
                saveDataInLocalStorage(vm.orders, backUpKey);
            }

            function addItem(data, index) {
                if (index < 0) {
                    return;
                }
                if (!index) {
                    index = 0;
                }
                if (!vm.orders[index]) {
                    vm.orders[index] = [];
                }
                var item = _.find(vm.orders[index].order, function(o) {
                    return o.name == data.name;
                });
                if (item) {
                    item.quantity++;
                    item.totalPrice = item.quantity * item.price;
                } else {
                    vm.orders[index].order.push({
                        name: data.name,
                        quantity: 1,
                        price: parseInt(data.price),
                        totalPrice: parseInt(data.price)
                    });
                }
                saveDataInLocalStorage(vm.orders, backUpKey);
            }

            /// data is a JSON
            function saveDataInLocalStorage(data, key) {
                if (data && key) {
                    localStorage.setItem(key, JSON.stringify(angular.copy(data)));
                }
            }

            function getDataFromLocalStorage(key) {
                if (key) {
                    var data = localStorage.getItem(key);
                    if (key) {
                        return JSON.parse(data);
                    }
                }
            }

            var data = [{
                "name": "Blueberry Nights Thicccc Shake",
                "description": "Blueberry thickshake prepared with frozen blueberries, vanilla ice cream and low fat slim milk tastes heavenly sweet and creamy and it?s an anytime treat for a sweet tooth in you. Lift your summer spirit by having healthy blueberry shake for breakfast or dessert today.",
                "price": "239.85"
            }, {
                "name": "Kitty Kat Thicccc Shake - Choco",
                "description": "On Popular Demand! Creamy blend of Choco ice-cream, Kit Kat, and milk creating a rich, satisfying thickshake delight.",
                "price": "280.85"
            }, {
                "name": "The Breakup [chocolate Brownie Thicccc Shake]",
                "description": "This Brownie shake, aka \"The Break Up Shake\" is a super decadent treat every chocolate lover should taste at least once! Loaded with brownie chunks and decorated with choco sauce, this thickshake is packed with delicious chocolate flavour.",
                "price": "261.38"
            }, {
                "name": "Ferrero Rocher Thicccc Shake",
                "description": "At Shake It Off, you know it's the real ones and not the replicas.",
                "price": "316.73"
            }, {
                "name": "Lotus Biscoff Thicccc Shake",
                "description": "This is the new talk of the town. Made from premium imported lotus biscoff spread and cookies in our secret vanilla magic blend.",
                "price": "316.73"
            }, {
                "name": "New Snicka Snicka [Snickers] Thicccc Shake",
                "description": "Give up on anger. Order  Snicka Snicka! Now with more snickers added to the Vanilla",
                "price": "306.48"
            }, {
                "name": "Smoressss [roasted Marshmallows] Thicccc Shakes)",
                "description": "Re launching it after 2017. Order away!",
                "price": "296.23"
            }, {
                "name": "Cheesy Veg Momos",
                "description": "Freshly made dumplings with no question of preservatives",
                "price": "179"
            }, {
                "name": "Palak Paneer Momos (8 Pcs)",
                "description": "Savor the fusion of flavors with our Palak Paneer Momos. Delicate dumplings filled with the richness of paneer and the earthy goodness of spinach, a delectable twist on traditional momos.",
                "price": "181"
            }, {
                "name": "Veg Momos",
                "description": "Freshly made dumplings with no question of preservatives",
                "price": "159"
            }, {
                "name": "Cheesy Paneer Peri Peri Sammich",
                "description": "Bite into this mouthgasm of paneer, cheese and peri peri.",
                "price": "164.41"
            }, {
                "name": "Mexican Grill Cheese Sammich",
                "description": "Three types of cheese with a little Mexican twist.",
                "price": "164.38"
            }];
            vm.data = _.toArray(data)
            console.log(vm.data);
        }
    </script>
</body>

</html>
